# 文件路径字段修改说明

## 修改概述

将 `tasks` 表中的 `audio_file_path` 字段重命名为 `file_path`，使其能够支持音频文件和文本文件的统一存储。

## 数据库变更

### 字段修改
- **原字段名**: `audio_file_path`
- **新字段名**: `file_path`
- **字段类型**: `TEXT`
- **用途**: 存储音频文件(.mp3, .wav, .m4a, .flac)和文本文件(.txt)的路径

### 字段说明
- **`file_path`**: 文件路径，支持音频文件和文本文件
- **`text_content`**: 文本内容，存储音频转录结果或txt文件读取的内容

## 使用场景

### 1. 音频任务
```python
# 创建音频任务时
task = Task(
    task_id=task_id,
    task_type="audio",
    file_path="uploads/audio_123.mp3",  # 音频文件路径
    text_content=None,                  # 转录完成后填入
    reference_text="参考文本"
)
```

### 2. 文本任务（上传文件）
```python
# 创建文本任务时
task = Task(
    task_id=task_id,
    task_type="text",
    file_path="uploads/text_456.txt",   # 文本文件路径
    text_content="文件读取的内容",      # 直接填入文件内容
    reference_text=None
)
```

### 3. 文本任务（直接输入）
```python
# 创建文本任务时
task = Task(
    task_id=task_id,
    task_type="text",
    file_path=None,                     # 无文件路径
    text_content="直接输入的文本内容",   # 直接填入内容
    reference_text=None
)
```

## 文本编号提取

系统会从 `file_path` 中提取文本编号，支持以下文件类型：

| 文件类型 | 示例路径 | 提取的编号 |
|----------|----------|------------|
| 音频文件 | `uploads/123.mp3` | `123` |
| 音频文件 | `uploads/audio_456.wav` | `456` |
| 文本文件 | `uploads/789.txt` | `789` |
| 文本文件 | `uploads/text_001.txt` | `001` |

## API 接口变更

### 音频任务接口
```bash
# 上传音频文件，系统自动保存到 file_path
curl -X POST "http://localhost:8000/api/v1/tasks/audio" \
  -F "audio_file=@123.mp3" \
  -F "reference_text=参考文本"
```

### 文本任务接口
```bash
# 方式1: 直接传入文本内容（file_path 为空）
curl -X POST "http://localhost:8000/api/v1/tasks/text" \
  -H "Content-Type: application/json" \
  -d '{"text_content": "Hello world"}'

# 方式2: 上传文本文件（保存到 file_path，内容存入 text_content）
curl -X POST "http://localhost:8000/api/v1/tasks/text/upload" \
  -F "text_file=@456.txt"
```

## 查询接口

使用文本编号查询翻译结果：

```bash
# 查询音频文件的翻译结果
curl "http://localhost:8000/api/v1/translations/en/123/AUDIO"

# 查询文本文件的翻译结果
curl "http://localhost:8000/api/v1/translations/zh/456/TEXT"
```

## 数据库迁移

执行以下 SQL 脚本完成字段重命名：

```sql
-- 执行迁移脚本
psql -d voicelingua -f migrations/rename_audio_file_path_to_file_path.sql
```

## 兼容性说明

- **向后兼容**: 现有的音频任务功能完全不受影响
- **新增功能**: 支持文本文件上传和统一的文件路径管理
- **查询优化**: 统一的文本编号提取逻辑，支持音频和文本文件

## 注意事项

1. **文件存储**: 所有上传的文件都保存在 `uploads/` 目录下
2. **文件命名**: 使用 `{task_id}_{original_filename}` 格式避免冲突
3. **编码支持**: 文本文件支持 UTF-8、GBK、GB2312、Latin-1 编码
4. **文件大小**: 文本文件限制最大 10MB
5. **文件类型**: 仅支持 .txt 格式的文本文件