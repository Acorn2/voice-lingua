# VoiceLingua 数据库设计文档

## 概述

VoiceLingua 系统采用多层存储架构，结合关系型数据库 PostgreSQL、NoSQL 缓存 Redis 和腾讯云COS对象存储，以满足不同类型数据的存储需求和性能要求。（*推荐使用S3兼容存储以获得更好的生态支持*）

### 存储架构策略
- **PostgreSQL**：存储任务元数据、翻译结果、用户信息等结构化数据
- **Redis**：缓存热点数据、任务状态、会话信息等高频访问数据
- **腾讯云COS**：存储音频文件、文本文件、结果 JSON 文件等大文件

## PostgreSQL 数据库设计

### 1. 数据库表结构

#### 1.1 任务主表 (tasks)
```sql
CREATE TABLE tasks (
    task_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_type VARCHAR(20) NOT NULL, -- 'audio' 或 'text'
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, processing, completed, failed, cancelled
    languages JSONB NOT NULL, -- 目标语言列表，如 ["en", "zh", "ja"]
    audio_file_path TEXT, -- 腾讯云COS音频文件路径
    text_content TEXT, -- 原始文本内容
    reference_text TEXT, -- 参考文本（用于准确性校验）
    accuracy DECIMAL(5,4), -- STT 准确性分数 (0.0000-1.0000)
    error_message TEXT, -- 错误信息
    result_url TEXT, -- 腾讯云COS结果文件路径
    metadata JSONB, -- 扩展元数据，如处理时间、模型版本等
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE
);

COMMENT ON TABLE tasks IS '任务主表，记录所有转录和翻译任务';
COMMENT ON COLUMN tasks.task_type IS '任务类型：audio(音频转录+翻译) 或 text(纯文本翻译)';
COMMENT ON COLUMN tasks.status IS '任务状态：pending(待处理), processing(处理中), completed(已完成), failed(失败), cancelled(已取消)';
COMMENT ON COLUMN tasks.languages IS 'JSON数组，包含所有目标翻译语言';
COMMENT ON COLUMN tasks.accuracy IS 'STT转录准确性分数，仅音频任务有值';
```

#### 1.2 翻译结果表 (translation_results)
```sql
CREATE TABLE translation_results (
    id SERIAL PRIMARY KEY,
    task_id UUID NOT NULL REFERENCES tasks(task_id) ON DELETE CASCADE,
    target_language VARCHAR(10) NOT NULL, -- 目标语言代码，如 'en', 'zh', 'ja'
    source_type VARCHAR(10) NOT NULL, -- 'AUDIO' 或 'TEXT'
    source_text TEXT NOT NULL, -- 原始文本
    translated_text TEXT NOT NULL, -- 翻译后文本
    confidence DECIMAL(5,4), -- 翻译置信度
    model_version VARCHAR(50), -- 使用的翻译模型版本
    processing_time INTEGER, -- 处理时间（毫秒）
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- 创建唯一索引，确保同一任务的同一语言同一来源只有一条记录
    UNIQUE(task_id, target_language, source_type)
);

COMMENT ON TABLE translation_results IS '翻译结果表，存储每个任务的所有翻译结果';
COMMENT ON COLUMN translation_results.source_type IS '来源标记：AUDIO(来自音频转录) 或 TEXT(来自原始文本)';
COMMENT ON COLUMN translation_results.confidence IS '翻译置信度分数';
```

#### 1.3 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
    config_key VARCHAR(100) PRIMARY KEY,
    config_value JSONB NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

COMMENT ON TABLE system_configs IS '系统配置表，存储系统级配置参数';

-- 插入默认配置
INSERT INTO system_configs (config_key, config_value, description) VALUES 
('whisper_config', '{"model": "medium", "device": "cuda", "language": "zh"}', 'Whisper 模型配置'),
('translation_config', '{"model": "facebook/m2m100_418M", "max_length": 512}', '翻译模型配置'),
('system_limits', '{"max_upload_size": 104857600, "max_concurrent_tasks": 10, "memory_threshold": 80}', '系统限制配置');
```

#### 1.5 审计日志表 (audit_logs)
```sql
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    task_id UUID REFERENCES tasks(task_id),
    event_type VARCHAR(50) NOT NULL, -- 事件类型：task_created, task_started, task_completed, task_failed等
    event_data JSONB, -- 事件详细数据
    user_id VARCHAR(100), -- 用户ID（如果有用户系统）
    ip_address INET, -- 请求IP地址
    user_agent TEXT, -- 用户代理
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

COMMENT ON TABLE audit_logs IS '审计日志表，记录系统重要操作';
```

### 2. 索引设计

#### 2.1 性能优化索引
```sql
-- 任务表索引
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_created_at ON tasks(created_at DESC);
CREATE INDEX idx_tasks_type_status ON tasks(task_type, status);
CREATE INDEX idx_tasks_completed_at ON tasks(completed_at DESC) WHERE completed_at IS NOT NULL;

-- 翻译结果表索引
CREATE INDEX idx_translation_results_task_id ON translation_results(task_id);
CREATE INDEX idx_translation_results_lookup ON translation_results(target_language, source_type);
CREATE INDEX idx_translation_results_created_at ON translation_results(created_at DESC);

-- 任务表文本编号索引
CREATE INDEX idx_tasks_text_number ON tasks(text_number);

-- 审计日志表索引
CREATE INDEX idx_audit_logs_task_id ON audit_logs(task_id);
CREATE INDEX idx_audit_logs_event_type ON audit_logs(event_type);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
```

#### 2.2 复合索引
```sql
-- 支持复杂查询的复合索引
CREATE INDEX idx_tasks_status_type_created ON tasks(status, task_type, created_at DESC);
CREATE INDEX idx_translation_lookup_full ON translation_results(target_language, source_type, task_id);
```

### 3. 触发器和函数

#### 3.1 更新时间触发器
```sql
-- 自动更新 updated_at 字段的函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 为需要的表创建触发器
CREATE TRIGGER update_tasks_updated_at 
    BEFORE UPDATE ON tasks 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_system_configs_updated_at 
    BEFORE UPDATE ON system_configs 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### 3.2 自动生成文本编号函数
```sql
-- 自动生成文本编号的函数
CREATE OR REPLACE FUNCTION generate_text_id(
    p_task_id UUID,
    p_language VARCHAR(10),
    p_source_type VARCHAR(10)
) RETURNS VARCHAR(50) AS $$
DECLARE
    next_seq INTEGER;
    text_id VARCHAR(50);
BEGIN
    -- 直接使用任务的 text_number 字段
    SELECT text_number INTO text_id FROM tasks WHERE task_id = p_task_id;
    
    -- 如果没有 text_number，生成一个默认值
    IF text_id IS NULL THEN
        text_id := p_source_type || '_' || UPPER(p_language) || '_' || EXTRACT(EPOCH FROM NOW())::TEXT;
    END IF;
    
    RETURN text_id;
END;
$$ LANGUAGE plpgsql;
```

#### 3.3 审计日志触发器
```sql
-- 任务状态变更审计函数
CREATE OR REPLACE FUNCTION audit_task_changes()
RETURNS TRIGGER AS $$
BEGIN
    -- 记录状态变更
    IF OLD.status != NEW.status THEN
        INSERT INTO audit_logs (task_id, event_type, event_data)
        VALUES (
            NEW.task_id,
            'task_status_changed',
            jsonb_build_object(
                'old_status', OLD.status,
                'new_status', NEW.status,
                'change_time', NOW()
            )
        );
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建审计触发器
CREATE TRIGGER audit_task_status_changes
    AFTER UPDATE ON tasks
    FOR EACH ROW
    WHEN (OLD.status IS DISTINCT FROM NEW.status)
    EXECUTE FUNCTION audit_task_changes();
```

### 4. 视图设计

#### 4.1 任务统计视图
```sql
-- 任务统计视图
CREATE VIEW task_statistics AS
SELECT 
    task_type,
    status,
    COUNT(*) as task_count,
    AVG(EXTRACT(EPOCH FROM (completed_at - created_at))/60) as avg_processing_minutes,
    AVG(accuracy) as avg_accuracy
FROM tasks 
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY task_type, status;

COMMENT ON VIEW task_statistics IS '任务统计视图，显示最近30天的任务统计信息';
```

#### 4.2 翻译结果汇总视图
```sql
-- 翻译结果汇总视图
CREATE VIEW translation_summary AS
SELECT 
    t.task_id,
    t.task_type,
    t.status,
    t.created_at,
    t.completed_at,
    t.accuracy,
    array_agg(DISTINCT tr.target_language ORDER BY tr.target_language) as completed_languages,
    array_agg(DISTINCT tr.source_type ORDER BY tr.source_type) as source_types,
    COUNT(tr.id) as translation_count
FROM tasks t
LEFT JOIN translation_results tr ON t.task_id = tr.task_id
GROUP BY t.task_id, t.task_type, t.status, t.created_at, t.completed_at, t.accuracy;

COMMENT ON VIEW translation_summary IS '翻译结果汇总视图，显示每个任务的翻译完成情况';
```

## Redis 缓存设计

### 1. 缓存策略

#### 1.1 键命名规范
```
# 任务相关
task:{task_id}                    # 任务基本信息
task_status:{task_id}             # 任务状态
task_progress:{task_id}           # 任务进度

# 翻译结果相关
translation:{language}:{text_id}:{source}  # 具体翻译结果
translations:{task_id}            # 任务所有翻译结果

# 系统配置相关
config:{config_key}               # 系统配置
settings:whisper                  # Whisper 配置
settings:translation              # 翻译配置

# 锁相关
lock:{resource_type}:{resource_id} # 分布式锁

# 统计相关
stats:daily:{date}                # 每日统计
stats:hourly:{date_hour}          # 每小时统计
```

#### 1.2 数据类型和过期时间
```
# 字符串类型
task:{task_id} -> JSON            # TTL: 24小时
task_status:{task_id} -> status   # TTL: 1小时
translation:{key} -> JSON         # TTL: 2小时

# 哈希类型
task_progress:{task_id} -> Hash   # TTL: 1小时
{
    "total_steps": 5,
    "completed_steps": 2,
    "current_step": "translation",
    "progress_percent": 40
}

# 集合类型
active_tasks -> Set               # 活跃任务集合
failed_tasks -> Set               # 失败任务集合

# 有序集合类型
task_queue:{priority} -> ZSet     # 任务队列（按优先级）
```

### 2. 缓存操作模式

#### 2.1 写入策略
- **Write-Through**：同时写入数据库和缓存
- **Write-Behind**：先写缓存，异步写数据库（适用于高频更新的状态信息）

#### 2.2 读取策略
- **Cache-Aside**：先查缓存，未命中则查数据库并更新缓存
- **Read-Through**：缓存代理自动从数据库加载数据

#### 2.3 失效策略
- **TTL 过期**：设置合理的过期时间
- **主动失效**：数据更新时主动删除相关缓存
- **LRU 淘汰**：内存不足时淘汰最近最少使用的数据

## 腾讯云COS对象存储设计

### 1. 存储结构

#### 1.1 目录结构
```
voicelingua-bucket/
├── uploads/                      # 上传文件
│   ├── audio/
│   │   ├── {year}/{month}/{day}/
│   │   │   └── {task_id}_{filename}
│   └── text/
│       ├── {year}/{month}/{day}/
│       │   └── {task_id}_{filename}
├── results/                      # 结果文件
│   ├── {year}/{month}/{day}/
│   │   ├── {task_id}/
│   │   │   ├── transcription.json
│   │   │   ├── translations.json
│   │   │   └── final_result.json
├── temp/                         # 临时文件
│   ├── processing/
│   └── cache/
└── backups/                      # 备份文件
    ├── {year}/{month}/{day}/
```

#### 1.2 文件命名规范
```
# 音频文件
{task_id}_{timestamp}_{original_filename}
例：550e8400-e29b-41d4-a716-446655440000_20241201_120000_audio.mp3

# 文本文件
{task_id}_{timestamp}_{type}.txt
例：550e8400-e29b-41d4-a716-446655440000_20241201_120000_reference.txt

# 结果文件
{task_id}_final_result.json
{task_id}_transcription_result.json
{task_id}_translation_{language}_{source}.json
```

### 2. 存储策略

#### 2.1 生命周期管理
- **频繁访问层（0-30天）**：Standard 存储类别
- **偶尔访问层（30-90天）**：IA (Infrequent Access) 存储类别
- **归档层（90天+）**：Glacier 存储类别
- **自动删除（1年+）**：自动删除临时文件和过期备份

#### 2.2 版本控制
- **启用版本控制**：防止意外删除和覆盖
- **生命周期策略**：自动清理旧版本

#### 2.3 访问控制
- **最小权限原则**：每个组件只获得必要的权限
- **预签名 URL**：用于临时访问文件
- **跨域配置**：支持前端直接上传

## 数据备份与恢复

### 1. 备份策略

#### 1.1 PostgreSQL 备份
```bash
# 每日全量备份
pg_dump -h localhost -U postgres -d voicelingua | gzip > /backups/voicelingua_$(date +%Y%m%d).sql.gz

# 每小时增量备份（WAL 归档）
archive_command = 'cp %p /backups/wal_archive/%f'

# 定期备份到异地腾讯云COS
coscmd sync /backups/ cos://voicelingua-backups/database/
```

#### 1.2 Redis 备份
```bash
# RDB 快照备份
redis-cli BGSAVE

# AOF 持久化
appendonly yes
appendfsync everysec

# 定期同步到腾讯云COS
coscmd sync /var/lib/redis/ cos://voicelingua-backups/redis/
```

### 2. 恢复策略

#### 2.1 数据库恢复
```bash
# 从备份恢复数据库
gunzip -c /backups/voicelingua_20241201.sql.gz | psql -h localhost -U postgres -d voicelingua

# 时间点恢复（PITR）
pg_basebackup + WAL 重放
```

#### 2.2 缓存恢复
```bash
# Redis 数据恢复
redis-cli FLUSHALL
redis-cli < backup.rdb
```

## 性能优化

### 1. 查询优化

#### 1.1 常用查询模式优化
```sql
-- 按状态查询任务（添加复合索引）
EXPLAIN ANALYZE 
SELECT * FROM tasks 
WHERE status = 'processing' AND task_type = 'audio' 
ORDER BY created_at DESC LIMIT 10;

-- 按语言和来源查询翻译结果
EXPLAIN ANALYZE
SELECT tr.* FROM translation_results tr
JOIN tasks t ON tr.task_id = t.task_id
WHERE tr.target_language = 'en' AND tr.source_type = 'AUDIO'
  AND t.text_number = '001';
```

#### 1.2 分页查询优化
```sql
-- 使用游标分页替代 OFFSET
SELECT * FROM tasks 
WHERE created_at < '2024-01-01 10:00:00'
ORDER BY created_at DESC 
LIMIT 20;
```

### 2. 连接池配置

#### 2.1 PostgreSQL 连接池
```python
# SQLAlchemy 连接池配置
SQLALCHEMY_ENGINE_OPTIONS = {
    'pool_size': 20,
    'max_overflow': 30,
    'pool_timeout': 30,
    'pool_recycle': 3600,
    'pool_pre_ping': True
}
```

#### 2.2 Redis 连接池
```python
# Redis 连接池配置
REDIS_POOL_CONFIG = {
    'max_connections': 100,
    'retry_on_timeout': True,
    'socket_keepalive': True,
    'socket_keepalive_options': {}
}
```

### 3. 监控指标

#### 3.1 数据库监控
- **连接数**：活跃连接、空闲连接
- **查询性能**：慢查询、查询时间分布
- **资源使用**：CPU、内存、磁盘 I/O
- **锁情况**：死锁、长时间锁等待

#### 3.2 缓存监控
- **命中率**：缓存命中率、未命中率
- **内存使用**：已用内存、可用内存
- **键空间**：键数量、过期键数量
- **网络流量**：输入/输出字节数

## 数据一致性

### 1. 事务管理

#### 1.1 ACID 保证
```sql
-- 任务状态更新事务
BEGIN;
    UPDATE tasks SET status = 'completed', completed_at = NOW() WHERE task_id = ?;
    INSERT INTO audit_logs (task_id, event_type, event_data) VALUES (?, 'task_completed', ?);
COMMIT;
```

#### 1.2 分布式事务
- **两阶段提交**：数据库操作和缓存操作的一致性
- **补偿机制**：失败时的回滚操作
- **幂等性**：确保重复操作的安全性

### 2. 数据同步

#### 2.1 缓存与数据库同步
- **双写一致性**：同时更新数据库和缓存
- **异步同步**：通过消息队列异步同步
- **数据校验**：定期校验缓存和数据库的一致性

#### 2.2 主从复制
- **读写分离**：主库写，从库读
- **故障切换**：主库故障时的自动切换
- **数据延迟监控**：监控主从延迟

这个数据库设计方案充分考虑了系统的可扩展性、高可用性和数据一致性需求，能够支撑 VoiceLingua 系统的高并发访问和大数据量处理。 